{
  "objects": [
    {
      "period": "6 Hours",
      "name": "Every 6 hours",
      "id": "DefaultSchedule",
      "type": "Schedule",
      "startAt": "FIRST_ACTIVATION_DATE_TIME"
    },
    {
      "directoryPath": "#{myS3PerformerPath}/#{format(@scheduledStartTime, 'YYYY-MM-dd-HH-mm-ss')}",
      "name": "S3PerformerLocation",
      "id": "S3PerformerLocation",
      "type": "S3DataNode"
    },
    {
      "dependsOn": [
        {
          "ref": "TableBackupPerformerActivity"
        },
        {
          "ref": "TableBackupPlaylistActivity"
        }
      ],
      "name": "Invoke_Lambda_Activity",
      "id": "Invoke_Lambda_Activity",
      "runsOn": {
        "ref": "New_EC2Instance"
      },
      "myComment": "This object is a ShellCommandActivity. It is used to specify the command linux shell command that will be invoked. In this case, it invokes Lambda Function.",
      "type": "ShellCommandActivity",
      "command": "aws lambda  --region #{myRegion} invoke --function-name #{myLambdaFunction} outfile.txt"
    },
    {
      "readThroughputPercent": "#{myDDBReadThroughputRatio}",
      "name": "DDBSourcePlaylistTable",
      "id": "DDBSourcePlaylistTable",
      "type": "DynamoDBDataNode",
      "tableName": "#{myDDBSourcePlaylistTableName}"
    },
    {
      "name": "EmrClusterForBackup",
      "coreInstanceType": "m1.medium",
      "coreInstanceCount": "1",
      "masterInstanceType": "m1.medium",
      "amiVersion": "3.8.0",
      "id": "EmrClusterForBackup",
      "region": "#{myRegion}",
      "type": "EmrCluster",
      "terminateAfter": "30 Minutes"
    },
    {
      "directoryPath": "#{myS3PlaylistPath}/#{format(@scheduledStartTime, 'YYYY-MM-dd-HH-mm-ss')}",
      "name": "S3PlaylistLocation",
      "id": "S3PlaylistLocation",
      "type": "S3DataNode"
    },
    {
      "output": {
        "ref": "S3PlaylistLocation"
      },
      "input": {
        "ref": "DDBSourcePlaylistTable"
      },
      "maximumRetries": "2",
      "name": "TableBackupPlaylistActivity",
      "step": "s3://dynamodb-emr-#{myRegion}/emr-ddb-storage-handler/2.1.0/emr-ddb-2.1.0.jar,org.apache.hadoop.dynamodb.tools.DynamoDbExport,#{output.directoryPath},#{input.tableName},#{input.readThroughputPercent}",
      "id": "TableBackupPlaylistActivity",
      "runsOn": {
        "ref": "EmrClusterForBackup"
      },
      "type": "EmrActivity",
      "resizeClusterBeforeRunning": "true"
    },
    {
      "readThroughputPercent": "#{myDDBReadThroughputRatio}",
      "name": "DDBSourcePerformerTable",
      "id": "DDBSourcePerformerTable",
      "type": "DynamoDBDataNode",
      "tableName": "#{myDDBSourcePerformerTableName}"
    },
    {
      "resourceRole": "DataPipelineDefaultResourceRole",
      "role": "DataPipelineDefaultRole",
      "imageId": "#{myImageId}",
      "instanceType": "#{myInstanceType}",
      "name": "New_EC2Instance",
      "id": "New_EC2Instance",
      "type": "Ec2Resource",
      "region": "#{myRegion}",
      "myComment": "This object is used to create an Amazon EC2 Instance that activities in the pipeline can run on.",
      "terminateAfter": "30 Minutes"
    },
    {
      "output": {
        "ref": "S3PerformerLocation"
      },
      "input": {
        "ref": "DDBSourcePerformerTable"
      },
      "maximumRetries": "2",
      "name": "TableBackupPerformerActivity",
      "step": "s3://dynamodb-emr-#{myRegion}/emr-ddb-storage-handler/2.1.0/emr-ddb-2.1.0.jar,org.apache.hadoop.dynamodb.tools.DynamoDbExport,#{output.directoryPath},#{input.tableName},#{input.readThroughputPercent}",
      "id": "TableBackupPerformerActivity",
      "runsOn": {
        "ref": "EmrClusterForBackup"
      },
      "type": "EmrActivity",
      "resizeClusterBeforeRunning": "true"
    },
    {
      "failureAndRerunMode": "CASCADE",
      "schedule": {
        "ref": "DefaultSchedule"
      },
      "resourceRole": "DataPipelineDefaultResourceRole",
      "role": "DataPipelineDefaultRole",
      "pipelineLogUri": "s3://treefort-dynamo-backups/etl/logs/",
      "scheduleType": "cron",
      "name": "Default",
      "id": "Default",
      "myComment": "This object is used to set default configuration for objects in the pipeline"
    }
  ],
  "parameters": [
    {
      "description": "Source DynamoDB table name for performers",
      "id": "myDDBSourcePerformerTableName",
      "type": "String"
    },
    {
      "description": "S3 path for performer backup",
      "id": "myS3PerformerPath",
      "type": "AWS::S3::ObjectKey"
    },
    {
      "description": "Lambda Function name",
      "id": "myLambdaFunction",
      "myComment": "This Parameter specifies the Lambda function name.",
      "type": "String"
    },
    {
      "default": "ami-8fcee4e5",
      "description": "Image Id",
      "id": "myImageId",
      "myComment": "This Parameter specifies image id",
      "type": "String"
    },
    {
      "description": "S3 path for performer backup",
      "id": "myS3PlaylistPath",
      "type": "AWS::S3::ObjectKey"
    },
    {
      "description": "S3 path for pipeline logs.",
      "id": "myS3LogsPath",
      "type": "AWS::S3::ObjectKey",
      "myComment": "This Parameter specifies the S3 logging path for the pipeline. It is used by the 'Default' object to set the 'pipelineLogUri' value. Using Parameters helps users avoid hard coding variables in pipeline definitions. Users can instead supply these parameters when calling 'aws datapipeline put-pipeline-definition' or 'aws datapipeline activate-pipeline-definition'."
    },
    {
      "default": "0.25",
      "watermark": "Enter value between 0.1-1.0",
      "description": "DynamoDB read throughput ratio",
      "id": "myDDBReadThroughputRatio",
      "type": "Double"
    },
    {
      "default": "us-west-2",
      "description": "Region",
      "id": "myRegion",
      "myComment": "This Parameter specifies region",
      "type": "String"
    },
    {
      "description": "Source DynamoDB table name for Playlist",
      "id": "myDDBSourcePlaylistTableName",
      "type": "String"
    },
    {
      "default": "t2.micro",
      "description": "Instance Type",
      "id": "myInstanceType",
      "type": "String",
      "myComment": "This Parameter specifies instance type"
    }
  ],
  "values": {
    "myS3PlaylistPath": "s3://treefort-dynamo-backups/dev/playlist/",
    "myDDBSourcePerformerTableName": "dev-performer",
    "myImageId": "ami-1e299d7e",
    "myS3LogsPath": "s3://treefort-dynamo-backups/etl/logs/",
    "myDDBReadThroughputRatio": "0.25",
    "myInstanceType": "t2.micro",
    "myS3PerformerPath": "s3://treefort-dynamo-backups/dev/performer/",
    "myLambdaFunction": "etl",
    "myDDBSourcePlaylistTableName": "dev-playlist",
    "myRegion": "us-west-2"
  }
}